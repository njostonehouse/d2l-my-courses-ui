<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../../d2l-search-widget/d2l-search-widget.html">
<link rel="import" href="d2l-image-tile-grid.html">

<dom-module id="d2l-basic-image-selector">
	<template>
		<style>
			d2l-search-widget {
				width: 50%;
				margin-bottom: 45px;
			}

			.no-results-search-text {
				font-weight: bolder;
				word-wrap: break-word;
			}

			.no-results-text {
				font-size: 30px;
				margin-bottom: 12px;
			}
		</style>

		<d2l-ajax
			id="imagesRequest"
			url="[[_searchString]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onDefaultImagesRequestResponse">
		</d2l-ajax>

		<d2l-search-widget
			id="image-search"
			class="small"
			search-action="[[_searchAction]]"
			placeholder-text="[[localize('search')]]"
			search-field-name="search"
		>
		</d2l-search-widget>

		<template is="dom-if" if="{{_showGrid}}">
			<d2l-image-tile-grid
				image-catalog-location="[[imageCatalogLocation]]"
				organization="[[organization]]"
				images="[[_images]]"
			></d2l-image-tile-grid>
		</template>

		<template is="dom-if" if="{{!_showGrid}}">
			<div class="no-results-area">
				<div class="no-results-text">
					<span>{{_noResultsTextStart}}</span><span class="no-results-search-text">{{_noResultsTextMid}}</span><span>{{_noResultsTextEnd}}</span>
				</div>
				<div class="please-change-text">{{localize('images.pleaseModify')}}</div>
			</div>
		</template>
	</template>
	<script>
		'use strict';

		Polymer({
			is: 'd2l-basic-image-selector',
			ready: function() {
				this._images = this._defaultImages;
				this.$$('d2l-search-widget').addEventListener('search-results-changed', function(response) {
					var searchWidget = this.$$('d2l-search-widget');

					var delimiter = '$$$DELIMITER???',
						searchRegex = /search=([^&]*)/,
						searchHref = decodeURIComponent( response.detail.getLinkByRel('self').href ),
						match = searchRegex.exec(searchHref),
						noResultsText = this.localize('images.noResults', 'search', delimiter),
						userSearchText = (match.length > 1) ? match[1] : null,
						noResultsSplit = noResultsText.split(delimiter);

					// Throw out empty searches
					// TODO: d2l-search-widget property that sends events instead of making network calls
					if (match[1] === "") {
						this._searchImages = [];
						this._showGrid = true;
						this._updateImages();
						return;
					}

					this._searchImages = searchWidget.searchResults.entities || [];
					this._noResultsTextStart = noResultsSplit[0];
					this._noResultsTextMid = userSearchText;
					this._noResultsTextEnd = noResultsSplit[1];

					this._showGrid = (userSearchText || '') === '' || this._searchImages.length > 0;

					this._updateImages();
				}.bind(this));
			},
			properties: {
				imageCatalogLocation: String,
				organization: {
					type: Object,
					observer: '_updateOrganization'
				},
				_searchString: String,
				_images: Array,
				_searchAction: String,
				_noResultsTextStart: String,
				_noResultsTextMid: String,
				_noResultsTextEnd: String,
				_showGrid: Boolean,
			},
			behaviors: [ Polymer.D2L.MyCourses.LocalizeBehavior ],
			focusableNodesOverride: function() {
				var imageTileFocusables = [];
				var grid = this.$$('d2l-image-tile-grid');
				[].forEach.call(grid.querySelectorAll('d2l-image-selector-tile'), function(imageTile) {
					Array.prototype.push.apply(imageTileFocusables, Polymer.dom(imageTile.root).querySelectorAll('button'));
				});
				return imageTileFocusables;
			},
			_sirenParser: document.createElement('d2l-siren-parser'),
			_searchImages: [],
			_defaultImages: [],
			_onDefaultImagesRequestResponse: function(response) {
				if (response.detail.status !== 200) {
					return;
				}

				var parsedResponse = this._sirenParser.parse(response.detail.xhr.response);
				this._defaultImages = parsedResponse.entities || [];

				this._updateImages();
			},
			_updateOrganization: function(organization) {
				this._searchAction = JSON.stringify(this._getSearchAction());
				this._showGrid = true;
				this.$$('d2l-search-widget').clear();

				// TODO: Add 'department' to the organization HM entity and use that information here
				if (organization && (organization.properties || {}).name) {
					this._searchString = this._getSearchStringValue(organization.properties.name, true);
				} else {
					// This is better than 'default' because we get random defaults rather than starting at 0
					this._searchString = this._getSearchStringValue('THIS_WILL_RETURN_NOTHING', true);
				}

				if (this._searchString !== null) {
					this.$.imagesRequest.generateRequest();
				}
			},
			_getSearchAction: function() {
				return {
					name: 'search-catalog-image',
					method: 'GET',
					href: this._searchPath,
					fields: [
						{ name: 'search', type: 'search', value: '' }
					]
				};
			},
			get _searchPath() {
				if (!this.imageCatalogLocation) {
					return null;
				}

				var endSlash = this.imageCatalogLocation.slice(-1) === '/' ? '' : '/';
				return this.imageCatalogLocation + endSlash + 'images';
			},
			_getSearchStringValue: function(search, appendMore) {
				var appendMoreQuery = appendMore ? '&appendMore=1' : '';
				return this._searchPath + '?search=' + search + appendMoreQuery;
			},
			_updateImages: function() {
				var searchImages = this._searchImages || [];
				this._images = (searchImages.length > 0) ? searchImages : this._defaultImages;
			}
		});
	</script>
</dom-module>
