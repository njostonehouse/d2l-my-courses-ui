<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../localize-behavior.html">
<link rel="import" href="../d2l-course-tile-responsive-grid-behavior.html">
<link rel="import" href="../d2l-course-tile-grid-styles.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="d2l-image-selector-tile-styles.html">

<dom-module id="d2l-image-selector-tile">
	<template>
		<style include="d2l-image-selector-tile-styles"></style>

		<div class="d2l-image-tile">
			<div class="padding"></div>
			<div class="click-overlay"
				on-click="_toggleOverlayOn"
				on-blur="_toggleOverlayOff"
				tabindex="-1">
			</div>
			<div class="d2l-image-tile-overlay">
				<button class="overlay-button" on-tap="_selectImage" on-focus="_toggleOverlayOn" on-blur="_toggleOverlayOff">
					<div class="overlay-button-inner">
						<d2l-icon class="camera-icon" icon="d2l-tier1:pic" aria-hidden="true"></d2l-icon>
						<span class="overlay-button-text">{{localize('useThisImage')}}</span>
					</div>
				</button>
			</div>
			<div class="d2l-image-tile-content">
				<img src="[[_getImageHref(image)]]" srcset="[[_getMoImageHref(image)]]"></img>
			</div>

			<d2l-ajax
				id="setImageRequest"
				url="[[_setImageUrl]]"
				method="POST"
				headers='{ "Accept": "application/vnd.siren+json" }'
				on-iron-ajax-response="_onSetImageResponse"
				on-iron-ajax-error="_onSetImageError">
			</d2l-ajax>

		</div>
	</template>

	<script>
		'use strict';

		Polymer({
			is: 'd2l-image-selector-tile',
			properties: {
				image: Object,
				organization: Object,
				_setImageUrl: String
			},
			behaviors: [
				Polymer.D2L.MyCourses.LocalizeBehavior
			],
			_toggleOverlayOn: function() {
				this.toggleClass('mobile-selected', true, this.$$('.d2l-image-tile'));
			},
			_toggleOverlayOff: function() {
				this.toggleClass('mobile-selected', false, this.$$('.d2l-image-tile'));
			},
			_getImageHref: function(image) {
				var tile = image && image.getLinkByClass('tile');
				if (tile) {
					return tile.href;
				}
			},
			_getMoImageHref: function(image) {
				if (!image) {
					return;
				}
				var courseImageLinks = image.getLinksByClass('tile'),
					srcset = '';
				courseImageLinks.forEach(function(link) {
					srcset += link.hasClass('min') && !link.hasClass('high-density') ? link.href + ' 145w,' : '';
					srcset += link.hasClass('min') && link.hasClass('high-density') ? link.href + ' 290w,' : '';
					srcset += link.hasClass('mid') && !link.hasClass('high-density') ? link.href + ' 220w,' : '';
					srcset += link.hasClass('mid') && link.hasClass('high-density') ? link.href + ' 440w,' : '';
					srcset += link.hasClass('max') && !link.hasClass('high-density') ? link.href + ' 540w,' : '';
					srcset += link.hasClass('max') && link.hasClass('high-density') ? link.href + ' 1080w,' : '';
				});
				return srcset;
			},
			_getSetImageUrl: function() {
				if (this.organization && this.image ) {
					var setImageAction = this.organization.getActionByName('set-catalog-image') || {},
						setImagePath = setImageAction.href || '';

					var url = this.image.getLinkByRel('self').href,
						regex = /\/images\/[^\/?]*/i,
						match = url.match(regex);

					if (setImagePath !== '' && match) {
						return setImagePath + '?imagePath=' + match[0];
					}
				}

				return '';
			},
			_onSetImageResponse: function() {
				// TODO: Use this or remove it
			},
			_onSetImageError: function() {
				// TODO: implement error handing of some sort
			},
			_selectImage: function() {
				this._setImageUrl = this._getSetImageUrl();
				this.$.setImageRequest.generateRequest();
				this.fire('close-simple-overlay');
			}
		});
	</script>
</dom-module>
